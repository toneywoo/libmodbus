# 智能楼宇照明控制 Modbus 应用说明

[...保留原有全部内容...]

## 数据包深度解析

### 功能1：多回路控制（功能码0x0F）

#### 请求帧构成
```python
# 控制8个回路的完整请求帧
request = [
    0x0A,       # 区域控制器地址
    0x0F,       # 功能码
    0x00, 0x00, # 起始地址(00001)
    0x00, 0x08, # 回路数量(8个)
    0x01,       # 字节计数(1字节)
    0x55,       # 控制数据(01010101)
    0x12, 0x34  # CRC校验
]
# 控制效果：1,3,5,7回路开启，2,4,6,8回路关闭

# 对应的C函数调用
err = modbus_write_bits(
    ctx,          # Modbus上下文
    1,            # 起始地址(00001)
    8,            # 回路数量
    [1,0,1,0,1,0,1,0]  # 控制状态数组
);
```

#### 响应帧解析
```python
response = [
    0x0A,       # 设备地址
    0x0F,       # 功能码
    0x00, 0x00, # 起始地址
    0x00, 0x08, # 回路数量
    0x55, 0x66  # CRC校验
]
```

### 功能2：能耗数据采集（功能码0x03）

#### 32位数据传输
```python
# 请求瞬时功率
request = [
    0x14,       # 电表地址
    0x03,       # 功能码
    0x00, 0x48, # 起始地址(40073)
    0x00, 0x02, # 寄存器数量(2个)
    0x12, 0x34  # CRC校验
]

# 响应帧（大端序32位数据）
response = [
    0x14,       # 设备地址
    0x03,       # 功能码
    0x04,       # 数据字节数(4字节)
    0x00,       # 高位字节
    0x00,       # 
    0x13,       # 
    0x88,       # 低位字节 → 0x00001388 = 5000W
    0x55, 0x66  # CRC校验
]

# 数据解析函数
def parse_power(msb1, msb2, lsb1, lsb2):
    """解析32位功率数据"""
    return (msb1 << 24) | (msb2 << 16) | (lsb1 << 8) | lsb2
```

## 渐变控制时序
```mermaid
timeline
    title 照明渐变过程（2秒）
    section 主站指令
        0ms : 发送渐变指令
             0x0A 0x10 0x00 0x20 0x00 0x02 0x04 0x00 0x00 0x00 0x7D [CRC]
             (目标亮度:125, 时间:2000ms)
    section 从站响应
        50ms : 确认接收
              0x0A 0x10 0x00 0x20 0x00 0x02 [CRC]
    section 渐变过程
        100ms-2100ms : 亮度线性变化
    section 完成通知
        2100ms : 发送完成状态
                0x0A 0x17 0x00 0x20 0x00 0x7D [CRC]
```

## 附录C：照明控制位映射表
| 位位置 | 回路号 | 物理位置       | 默认状态 |
|--------|--------|----------------|----------|
| bit0   | 1      | 东侧主照明     | ON       |
| bit1   | 2      | 西侧应急照明   | OFF      |
| ...    | ...    | ...            | ...      |
| bit7   | 8      | 走廊装饰灯     | ON       |

## 附录D：典型场景指令集
```python
# 全开场景
scene_on = [
    0x0A, 0x0F, 0x00, 0x00, 0x00, 0x08, 0x01, 0xFF, [CRC]
]  # 0xFF = 11111111

# 节能场景
scene_eco = [
    0x0A, 0x0F, 0x00, 0x00, 0x00, 0x08, 0x01, 0x55, [CRC]
]  # 0x55 = 01010101
```