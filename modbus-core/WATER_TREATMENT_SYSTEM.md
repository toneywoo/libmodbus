# 水处理系统 Modbus 应用说明

[...保留原有全部内容...]

## 数据包深度解析

### 功能1：水质多参数读取（功能码0x04）

#### 复合请求帧
```python
request = [
    0x10,       # 水质分析仪地址
    0x04,       # 功能码(读输入寄存器)
    0x00, 0x00, # 起始地址(30001)
    0x00, 0x03, # 寄存器数量(3个)
    0xF1, 0xCB  # CRC校验
]

# C函数调用示例
err = modbus_read_input_registers(
    ctx,          # Modbus上下文
    30001,        # 起始地址
    3,            # 参数数量
    data_buffer   # 存储数据的缓冲区
);
```

#### 多参数响应帧
```python
response = [
    0x10,       # 设备地址
    0x04,       # 功能码
    0x06,       # 数据字节数(6字节)
    # PH值(0.1精度)
    0x00, 0x41, # 0x0041 → 6.5
    # 浊度(NTU)
    0x00, 0x03, # 0x0003 → 3NTU
    # 余氯(mg/L,0.01精度)
    0x00, 0x23, # 0x0023 → 0.35mg/L
    0x12, 0x34  # CRC校验
]

# 数据解析示例
ph = response[3] / 10.0       # 6.5
turbidity = response[5]       # 3
chlorine = response[7] / 100.0 # 0.35
```

### 功能2：定量加药控制（功能码0x10）

#### 带流量补偿的加药指令
```python
control_frame = [
    0x20,       # 加药泵地址
    0x10,       # 功能码
    0x00, 0x01, # 控制地址(40002)
    0x00, 0x02, # 寄存器数量(2个)
    0x04,       # 数据字节数(4字节)
    # 基础加药量(0.1ml/s精度)
    0x00, 0x64, # 0x0064 → 10.0ml/s
    # 流量补偿系数(0.01精度)
    0x00, 0x32, # 0x0032 → 0.50
    0x55, 0x66  # CRC校验
]

# 对应的控制算法
dosing_rate = base_rate * (1 + flow_compensation)
```

## 传感器校准流程
```mermaid
sequenceDiagram
    participant M as 控制器
    participant S as PH传感器
    
    M->>S: 校准模式指令
        0x1E 0x06 0x00 0xFF 0x00 0x01 [CRC]
    S->>M: 确认响应
        0x1E 0x06 0x00 0xFF 0x00 0x01 [CRC]
    M->>S: 标准液7.0PH值
        0x1E 0x06 0x01 0x00 0x00 0x46 [CRC]
    S->>M: 校准完成
        0x1E 0x06 0x01 0x00 0x00 0x46 [CRC]
```

## 附录C：报警联动控制序列
```python
# PH值超限时的应急处理流程
emergency_sequence = [
    # 1. 关闭进水阀
    [0x30, 0x06, 0x00, 0x01, 0x00, 0x00, [CRC]],
    # 2. 启动应急加药泵(全速)
    [0x20, 0x06, 0x00, 0x02, 0x03, 0xE8, [CRC]],
    # 3. 触发声光报警
    [0x40, 0x06, 0x00, 0x10, 0x00, 0x01, [CRC]]
]
```

## 附录D：Modbus数据映射表
| 地址  | 参数       | 类型    | 转换公式       | 单位 |
|-------|------------|---------|----------------|------|
| 30001 | PH值       | UINT16  | 原始值/10       | pH   |
| 30002 | 浊度       | UINT16  | 原始值          | NTU  |
| 30003 | 余氯       | UINT16  | 原始值/100      | mg/L |
| 40002 | 加药量     | UINT16  | 原始值/10       | ml/s |
```